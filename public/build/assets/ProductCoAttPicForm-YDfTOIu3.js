import{E as tt}from"./base-Brf_yBAJ.js";import{E as et}from"./el-scrollbar-CorRZexq.js";import"./el-tooltip-l0sNRNKZ.js";import{E as ot}from"./el-popper-BSwFi-Wn.js";/* empty css                 *//* empty css                        */import{E as lt}from"./el-overlay-DlhaYkCE.js";import{E as it}from"./el-progress-Tp99XDUI.js";import{E as st}from"./el-button-DwHekHmB.js";import{r as _,p as at,f as nt,h as rt,i as g,a as d,w as r,c as b,M as dt,N as x,z as I,o as u,d as v,b as c,O as D,t as pt,n as ut,k as B}from"./app-lsMHx7PK.js";/* empty css                        *//* empty css                                                                            */import{_ as ct}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{E as mt}from"./index-B2x236EI.js";import{E as _t}from"./index-CgB4YGQ3.js";import{E as ft}from"./index-CiH_2dzV.js";import"./use-form-common-props-D5ONMDRx.js";import"./get-D4Sx4Yju.js";import"./isArray-Dxzbedgu.js";import"./index-6SUpneNt.js";import"./index-W2FmbPXI.js";import"./aria-n-U01RP3.js";import"./index-VxK2knAE.js";import"./vnode-DOoyDGs4.js";import"./icon-Domd4CnA.js";import"./refs-DiFgKJQR.js";import"./event-BB_Ol6Sd.js";import"./typescript-Bp3YSIOJ.js";import"./_baseClone-DtuwuByR.js";import"./_Uint8Array-CLotSVly.js";import"./_initCloneObject-Cco93VoI.js";import"./isEqual-CcYuS3NO.js";import"./index-BjFHEJIc.js";import"./index-DP1aPUMi.js";const gt=["src"],vt={class:"images scrollbar-flex-content"},bt={class:"demo-image__preview"},kt={key:0,class:"watermark"},Ct={class:"toggle_btn"},yt=["onChange"],wt=["onClick"],Et={class:"dialog-footer"},Vt={__name:"ProductCoAttPicForm",props:{colorOptions:Array,productId:Number,dialogColorVisible:Boolean},emits:["update:dialogColorVisible"],setup(L,{emit:S}){const $=L,h=S,U=_(!1),N=_([]),T=e=>{y.value=!0,A.value=e.url},j=(e,t)=>{},y=_(!1),A=_(""),f=_(!1),J=async()=>{await M(),f.value=!f.value,h("update:dialogColorVisible",!1)},m=at([]);let w=[];const M=async()=>{let e={pr_id:$.productId};const t=await I.post("/back/products/product_images",e,{});m.length=0,Object.assign(m,t.data||[]),w=JSON.parse(JSON.stringify(t.data))},R=nt(()=>[...m].sort((e,t)=>e.color_code==="combo"?1:t.color_code==="combo"?-1:0)),z=(e,t)=>{const o=e.target.files;if(!o.length)return;const l=m.find(i=>i.id===t);l&&(Array.from(o).forEach(i=>{const n={id:null,uid:Date.now()+Math.random(),product_id:l.product_id,image:URL.createObjectURL(i),alt_text:"",is_combination:l.color_name==="組合色"?1:0,file:i};l.product_images.push(n)}),e.target.value="")},O=(e,t,o=null)=>{const l=m.find(i=>i.id===e);if(l)if(t===null&&o){const i=l.product_images.findIndex(n=>n.id===null&&n.uid===o);i!==-1&&l.product_images.splice(i,1)}else l.product_images.forEach(i=>{i.id===t&&(i._delete=!0)})},q=(e,t)=>{const o=m.find(l=>l.id===e);o&&o.product_images.forEach(l=>{l.id===t&&(l._delete=!1)})},P=_([]),G=e=>{P.value[e].click()},H=()=>{const e=new FormData,t=K();let o=$.productId;t.forEach((l,i)=>{e.append(`product_options[${i}][po_id]`,l.po_id),l.product_images.forEach((n,p)=>{e.append(`product_options[${i}][product_images][${p}][id]`,n.id??""),e.append(`product_options[${i}][product_images][${p}][alt_text]`,n.alt_text),e.append(`product_options[${i}][product_images][${p}][is_combination]`,n.is_combination),e.append(`product_options[${i}][product_images][${p}][_delete]`,n._delete?1:0),n.id===null&&n.image instanceof File&&e.append(`product_options[${i}][product_images][${p}][image]`,n.image)})});for(const[l,i]of e.entries());e.entries().next().done||(e.append("product_id",o),E.value=!0,I.post("/back/products/updateProductImages",e,{headers:{"Content-Type":"multipart/form-data"}}).then(l=>{Object.assign(m,l.data.updated_product_options||[]),w=JSON.parse(JSON.stringify(l.data.updated_product_options)||[]),l.data&&W("success","更新成功"),E.value=!1}))},K=()=>m.map(e=>{const t=w.find(o=>o.id===e.id);return{po_id:e.id,product_images:e.product_images.filter(o=>{var k;const l=(k=t==null?void 0:t.product_images)==null?void 0:k.find(V=>V.id===o.id),i=l&&l.alt_text!==o.alt_text,n=o._delete,p=o.id===null;return i||n||p}).map(o=>({id:o.id??null,alt_text:o.alt_text,is_combination:o.is_combination,_delete:o._delete??!1,image:o.id?o.image:o.file}))}}).filter(e=>e.product_images.length>0),Q=e=>e.map(t=>t.image),W=(e,t)=>{mt({type:e,title:t,position:"bottom-left"})},F=()=>{f.value=!f.value,h("update:dialogColorVisible",!0)},E=_(!1);return(e,t)=>{const o=st,l=rt("Plus"),i=tt,n=it,p=lt,k=_t,V=ft,X=ot,Y=et;return u(),g(x,null,[d(o,{type:"info",onClick:t[0]||(t[0]=s=>J())},{default:r(()=>t[5]||(t[5]=[v(" 附圖管理 ")])),_:1}),d(p,{modelValue:U.value,"onUpdate:modelValue":t[3]||(t[3]=s=>U.value=s),title:"上傳項目"},{default:r(()=>[d(n,{"file-list":N.value,"onUpdate:fileList":t[1]||(t[1]=s=>N.value=s),"auto-upload":!1,"list-type":"picture-card","on-preview":T,"on-remove":j,multiple:""},{default:r(()=>[d(i,null,{default:r(()=>[d(l)]),_:1})]),_:1},8,["file-list"]),d(p,{modelValue:y.value,"onUpdate:modelValue":t[2]||(t[2]=s=>y.value=s)},{default:r(()=>[c("img",{"w-full":"",src:A.value,alt:"Preview Image"},null,8,gt)]),_:1},8,["modelValue"])]),_:1},8,["modelValue"]),(u(),b(dt,{to:"body"},[d(p,{modelValue:f.value,"onUpdate:modelValue":t[4]||(t[4]=s=>f.value=s),title:"產品附圖管理",style:{"min-width":"600px",width:"1100px","max-width":"1500px"},"before-close":F,"align-center":""},{footer:r(()=>[c("div",Et,[d(o,{type:"danger",onClick:H,loading:E.value},{default:r(()=>t[10]||(t[10]=[v("更新")])),_:1},8,["loading"]),d(o,{onClick:F,type:"info"},{default:r(()=>t[11]||(t[11]=[v("退出")])),_:1})])]),default:r(()=>[(u(!0),g(x,null,D(R.value,(s,xt)=>(u(),g("div",{key:s.id,class:"images-outside"},[c("h1",null,pt(s.color_code),1),d(Y,null,{default:r(()=>[c("div",vt,[(u(!0),g(x,null,D(s.product_images,(a,Z)=>(u(),g("div",{key:a.uid||a.id,class:"image-wrapper"},[c("div",{class:ut(["image-container",{"image-deleted":a._delete}])},[c("div",bt,[s.product_images.length?(u(),b(k,{key:0,style:{width:"100px",height:"100px"},src:a.image,"preview-src-list":Q(s.product_images),"show-progress":"",fit:"cover","initial-index":Z},null,8,["src","preview-src-list","initial-index"])):B("",!0)]),a._delete?(u(),g("div",kt,t[6]||(t[6]=[c("span",null,"刪除",-1)]))):B("",!0)],2),d(V,{modelValue:a.alt_text,"onUpdate:modelValue":C=>a.alt_text=C,style:{width:"200px"},placeholder:"Alt Text"},null,8,["modelValue","onUpdate:modelValue"]),c("div",Ct,[a.id===null?(u(),b(o,{key:0,onClick:C=>O(s.id,null,a.uid)},{default:r(()=>t[7]||(t[7]=[v("刪除")])),_:2},1032,["onClick"])):a._delete?(u(),b(o,{key:2,onClick:C=>q(s.id,a.id),type:"danger",plain:"",class:"del_btn"},{default:r(()=>t[9]||(t[9]=[v("還原")])),_:2},1032,["onClick"])):(u(),b(o,{key:1,onClick:C=>O(s.id,a.id)},{default:r(()=>t[8]||(t[8]=[v("標記刪除")])),_:2},1032,["onClick"]))])]))),128)),c("input",{type:"file",multiple:"",class:"hidden-input",ref_for:!0,ref:a=>P.value[s.id]=a,onChange:a=>z(a,s.id)},null,40,yt),c("div",{class:"upload-placeholder",onClick:a=>G(s.id)},[d(X,{class:"box-item",effect:"dark",content:"新增檔案",placement:"top"},{default:r(()=>[d(o,null,{default:r(()=>[d(i,null,{default:r(()=>[d(l)]),_:1})]),_:1})]),_:1})],8,wt)])]),_:2},1024)]))),128)),t[12]||(t[12]=c("div",null,null,-1))]),_:1},8,["modelValue"])]))],64)}}},ae=ct(Vt,[["__scopeId","data-v-b7321401"]]);export{ae as default};
