import"./base-F7uFyPqh.js";import{E as ze}from"./el-overlay-Bj7qX_gB.js";import{E as Oe}from"./el-pagination-14bCxj2f.js";import"./el-tag-CHIpI60o.js";import{E as je,a as Ie}from"./el-select-DAAqXABB.js";import"./el-scrollbar-CaHiQ2jM.js";import{E as Me}from"./el-popper-ZONQKOcb.js";/* empty css                 */import{E as qe,a as He}from"./el-table-column-CFApD_Ao.js";import{E as Ke}from"./el-checkbox-WpBCvKce.js";import"./el-tooltip-l0sNRNKZ.js";import{E as Qe}from"./el-popover-D-xYl_zR.js";import{E as We}from"./el-button-Da-vKTsK.js";import{Q as Xe,p as j,r as n,g as ae,c as le,w as r,o as E,b as f,a as l,d as v,u as V,P as Ye,i as A,O as se,N as re,k as ne,t as ie,l as de,W as Ge,X as Je,z as R,F as pe}from"./app-8VsGFcX2.js";import{_ as Ze}from"./BackendLayout-CRbk2zI0.js";import eo from"./ProductForm-DNhiuUSq.js";import oo from"./ProductCoEditForm-BkURAJF-.js";import to from"./ProductCoAddForm-C0QYC6JJ.js";/* empty css                        */import"./el-progress-CqvdZqzC.js";/* empty css                        *//* empty css                                                                            */import{_ as ao}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-TgJRFnZE.js";import{p as ue}from"./purify.es-pRVhHGEY.js";import{E as lo}from"./el-message-box-8JSOCrY3.js";import{E as so}from"./index-CBTzc5bQ.js";import{E as ro}from"./index-B5Eq5iIq.js";import"./vnode-O2VyULYN.js";import"./icon-DHQi6SUz.js";import"./refs-BvIol9SB.js";import"./index-Drrg9H66.js";import"./get-BfPBMtmL.js";import"./isArray-Dxzbedgu.js";import"./event-BB_Ol6Sd.js";import"./aria-C02hR53K.js";import"./use-form-common-props-CE_wdF9B.js";import"./index-CASUs_Ks.js";import"./typescript-Bp3YSIOJ.js";import"./isEqual-DFcmOf4i.js";import"./_Uint8Array-wIZ_amhJ.js";import"./index-BSNKJw_v.js";import"./castArray-Ce6QuK0j.js";import"./index-Cxidya-4.js";import"./index-CREfr6xS.js";import"./_initCloneObject-DQCSea_h.js";import"./el-main-Sz4hj5t3.js";import"./Header-LUJ3c-gi.js";import"./el-col-B6vcNyhf.js";import"./el-avatar--FhHPW_n.js";import"./index-l5omJr_w.js";/* empty css                     */import"./el-date-picker-BFi1JqKg.js";import"./dayjs.min-d9fAVkAR.js";import"./index-BPgBfIAq.js";import"./index-ChOKfouz.js";import"./el-radio-B_BxKOU2.js";import"./index-CsX1ZEWe.js";import"./_baseClone-BW0L-VQ6.js";import"./el-color-picker-bnQV7i-j.js";const no={class:"main-container"},io={class:"filters"},po={style:{display:"flex","align-items":"center",gap:"8px"}},uo=["src"],co={key:0},mo={style:{display:"flex","align-items":"center",gap:"8px"}},go={class:"example-pagination-block"},fo={__name:"Product",props:{products:{type:Object,required:!0},categories:{type:Object,required:!0},filters:Object,subcategories:Array},setup(Q){const W=Q,ce=Xe(),D=j({...W.products}),N=n(D.data),me=n([...W.categories]),g=ce.props.filters;g.subcategory_id=g.subcategory_id!=null?Number(g.subcategory_id):g.subcategory_id;const ge=o=>{w.value=o},i=j({name:"",title:"",subcategory_id:"",category_id:"",published_status:"",color_codes:[],subcategories:[],categories:me.value,description:"",special_message:"",special_start_at:null,special_end_at:null});j({data:[],current_page:1,last_page:null});const I=n(!1),M=n(!1),fe=({row:o})=>T.value===o.id?"activeRowFocus":"",ve=j({}),T=n(null),_=n([]),X=n(""),S=n(!1),Y=()=>{S.value=!S.value,we()},q=n([]);let w=n([]);const p=(o,e)=>{ro({type:o,title:e,position:"bottom-left"})},B=n(null),_e=n(null),be=o=>{switch(o){case"edit":return _e.value.formValidate();case"add":return B.value.formValidate()}},we=()=>{Je(()=>{B.value.resetForm(),B.value.resetFormData(),q.value=[],w.value=[]})};let d=new FormData;const ye=()=>{d=new FormData;const o=ue.sanitize(i.description),e=ue.sanitize(i.special_message);d.append("name",i.name),d.append("title",i.title),d.append("price",i.price),d.append("subcategory_id",i.subcategory_id),d.append("published_status",i.published_status),d.append("color_codes",i.color_codes),d.append("description",o),d.append("special_message",e),d.append("special_start_at",i.special_start_at?oe(i.special_start_at):i.special_start_at),d.append("special_end_at",i.special_end_at?oe(i.special_end_at):i.special_end_at);for(const[t,s]of d.entries());if(w.value.length>0){const t=w.value[0];t.raw&&d.append("image",t.raw)}else d.append("delete_image",!0);return d},H=n({}),Ce=async()=>{var o;try{await be("add"),await ye();const t=(await R.post("/back/products",d,{headers:{"Content-Type":"multipart/form-data"},validateStatus:s=>s<400})).data;t&&(S.value=!S.value,N.value.push(t),p("success","新增成功"))}catch(e){if(e.response&&e.response.status===403){const t=((o=e.response.data)==null?void 0:o.message)||"保存失敗";p("warning",t);return}}},Fe=async o=>{var e;try{let t={id:o};const y=(await R.delete(`/back/products/${o}`,t,{headers:{"Content-Type":"multipart/form-data"},validateStatus:k=>k<400})).data;if(y.message="success"){N.value=N.value.filter(k=>k.id!==o),p("success","移除成功");return}p("error","移除失敗")}catch(t){if(t.response&&t.response.status===403){const s=((e=t.response.data)==null?void 0:e.message)||"移除失敗";p("warning",s);return}}},G=n(null),K=n(!1),ke=async o=>{G.value=o.id,X.value=o.name+" 顏色管理";try{const e=await R.get(`/back/products/${o.id}/prod_options`);_.value=e.data,K.value=!0}catch{}};let c=new FormData;const xe=async o=>{if(F.value===o.id?F.value:null){if(!Object.keys(u.value).some(s=>u.value[s]!==o[s])&&!L.value.length){F.value=null;return}await J.value.colorFormValidate(),await Ee(),await Re(u.value.id)}else F.value=o.id,u.value={...o}},J=n(),u=n({}),F=n(null),Ee=()=>{if(c=new FormData,c.append("id",u.value.id),c.append("product_id",u.value.product_id),c.append("color_name",u.value.color_name),c.append("color_code",u.value.color_code),c.append("price",u.value.price),c.append("enable",u.value.enable),c.append("_method","PATCH"),L.value.length>0){const o=L.value[0].file;o&&c.append("image",o)}else u.value.image||c.append("delete_image",!0);return c},Ve=()=>{F.value=null,L.value=[]},L=n([]),Re=async o=>{var e;try{const t=await R.post(`/back/product_options/${o}`,c,{headers:{"Content-Type":"multipart/form-data"},validateStatus:s=>s<400});if(t.data){const s=_.value.findIndex(y=>y.id===t.data.id);s!==-1&&(_.value[s]={...t.data,enable:Number(t.data.enable),price:Number(t.data.price)},F.value=null),p("success","保存成功")}}catch(t){if(t.response&&t.response.status===403){const s=((e=t.response.data)==null?void 0:e.message)||"保存失敗";p("warning",s);return}p("error","保存失敗")}},$=n(),b=n({color_name:"",color_code:"",price:"",enable:"",image:"",product_id:G,published_status:1}),U=n(!1),h=n([]);let m=new FormData;const De=()=>{$.value.resetFields()},Se=()=>{U.value=!U.value,$.value.resetFields(),h.value=[]},Le=async()=>{await $.value.colorAddFormValidate(),await Ue(),await he()},Ue=()=>{if(m=new FormData,m.append("product_id",b.value.product_id),m.append("color_name",b.value.color_name),m.append("color_code",b.value.color_code),m.append("price",b.value.price),m.append("enable",b.value.enable),m.append("published_status",b.value.published_status),h.value.length>0){const o=h.value[0].file;o&&m.append("image",o)}else b.value.image||m.append("delete_image",!0);return m},he=async()=>{var o;try{const e=await R.post("/back/product_options",m,{headers:{"Content-Type":"multipart/form-data"},validateStatus:t=>t<400});e.data&&(_.value.push({...e.data,enable:Number(e.data.enable),price:Number(e.data.price),published_status:1}),U.value=!U.value,$.value.resetFields(),h.value=[],p("success","新增成功"))}catch(e){if(e.response.data.comboExist){p("error",e.response.data.message);return}if(e.response&&e.response.status===403){const t=((o=e.response.data)==null?void 0:o.message)||"新增失敗";p("warning",t);return}p("error","新增失敗")}},Z=async o=>{var e;try{if((await R.delete(`/back/product_options/${o}`)).data.message=="success"){_.value=_.value.filter(s=>s.id!=o),p("success","刪除成功");return}}catch(t){if(t.response&&t.response.status===403){const s=((e=t.response.data)==null?void 0:e.message)||"刪除失敗";p("warning",s);return}p("error","刪除失敗")}},Te=async o=>{try{const t=(await R.get(`/back/product_options/${o}/checkImgs`)).data.image_count;if(t>0){let s=`該產品顏色尚有 ${t} 張產品附圖，是否確認刪除?`;$e(s,o)}else Z(o)}catch{}},$e=(o,e)=>{lo.confirm(o,{confirmButtonText:"是",cancelButtonText:"沒有"}).then(()=>{Z(e)})};ae(ve,o=>{for(const e in o)if(o[e]){T.value=Number(e);return}T.value=""},{deep:!0}),ae(H,o=>{for(const e in o)if(o[e]){T.value=Number(e);return}T.value=""},{deep:!0});const ee=()=>{const o=Object.fromEntries(Object.entries(g).filter(([e,t])=>t!==""&&t!==null));pe.get(route("products.index"),o)};function Ae(o){o=D.current_page;const e=Object.fromEntries(Object.entries(g).filter(([t,s])=>s!==""&&s!==null));pe.get("/back/products",{...e,page:o})}function oe(o){if(!o)return null;let e;if(o instanceof Date)e=o;else if(typeof o=="string"){if(e=new Date(o),isNaN(e))return null}else return null;const t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),y=String(e.getDate()).padStart(2,"0"),k=String(e.getHours()).padStart(2,"0"),P=String(e.getMinutes()).padStart(2,"0"),z=String(e.getSeconds()).padStart(2,"0");return`${t}-${s}-${y} ${k}:${P}:${z}`}return(o,e)=>{const t=We,s=so,y=je,k=Ie,P=Ke,z=Me,x=qe,Ne=Qe,Be=He,Pe=Oe,te=ze;return E(),le(Ze,null,{switch:r(()=>[f("div",no,[f("div",null,[l(t,{type:"",onClick:Y,style:{margin:"10px 0"}},{default:r(()=>e[18]||(e[18]=[v("新增產品")])),_:1})]),f("div",io,[l(s,{modelValue:V(g).name,"onUpdate:modelValue":e[0]||(e[0]=a=>V(g).name=a),placeholder:"輸入產品名稱",style:{width:"240px"},onKeyup:e[1]||(e[1]=Ye(a=>ee(),["enter"]))},null,8,["modelValue"]),l(k,{modelValue:V(g).subcategory_id,"onUpdate:modelValue":e[2]||(e[2]=a=>V(g).subcategory_id=a),placeholder:"選擇類別",onChange:e[3]||(e[3]=a=>ee()),style:{width:"150px"}},{default:r(()=>[l(y,{label:"全部類別",value:""}),(E(!0),A(re,null,se(Q.subcategories,(a,C)=>(E(),le(y,{key:a.id,value:Number(a.id),label:a.name},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),l(Be,{data:N.value,style:{width:"100%"},"row-class-name":fe,border:""},{default:r(()=>[l(x,{width:"220",fixed:M.value?"left":!1,prop:"name"},{header:r(()=>[f("div",po,[e[19]||(e[19]=f("span",null,"產品名稱",-1)),l(z,{content:"固定/取消固定門市列"},{default:r(()=>[l(P,{modelValue:M.value,"onUpdate:modelValue":e[4]||(e[4]=a=>M.value=a)},null,8,["modelValue"])]),_:1})])]),_:1},8,["fixed"]),l(x,{prop:"title",label:"產品title"}),l(x,{label:"圖片"},{default:r(a=>[a.row.image?(E(),A("img",{key:0,src:a.row.image,alt:"店面圖片",style:{"max-width":"75px","border-radius":"4px"}},null,8,uo)):ne("",!0)]),_:1}),l(x,{prop:"subcategory.name",label:"類別"}),l(x,{prop:"published_status",label:"狀態",width:"120"},{default:r(a=>[f("span",null,ie(a.row.published_status==1?"上架":"下架"),1)]),_:1}),l(x,{prop:"color_codes",label:"顏色"},{default:r(a=>[(E(!0),A(re,null,se(a.row.color_codes,(C,O)=>(E(),A("span",{key:O},[v(ie(C),1),O<a.row.color_codes.length-1?(E(),A("span",co,"、 ")):ne("",!0)]))),128))]),_:1}),l(x,{width:"300",fixed:I.value?"right":!1},{header:r(()=>[f("div",mo,[e[20]||(e[20]=f("span",null,"操作",-1)),l(z,{content:"固定/取消固定操作列"},{default:r(()=>[l(P,{modelValue:I.value,"onUpdate:modelValue":e[5]||(e[5]=a=>I.value=a)},null,8,["modelValue"])]),_:1})])]),default:r(a=>[l(t,{onClick:C=>ke(a.row),size:"small",type:"info"},{default:r(()=>e[21]||(e[21]=[v(" 顏色管理 ")])),_:2},1032,["onClick"]),l(V(de),{href:o.route("images.show",a.row.id),style:{margin:"0 11px"}},{default:r(()=>[l(t,{size:"small",color:"#626aef",plain:""},{default:r(()=>e[22]||(e[22]=[v(" 附圖管理 ")])),_:1})]),_:2},1032,["href"]),l(V(de),{href:o.route("products.edit",a.row.id),style:{"margin-right":"11px"}},{default:r(()=>[l(t,{size:"small"},{default:r(()=>e[23]||(e[23]=[v(" 編輯 ")])),_:1})]),_:2},1032,["href"]),l(Ne,{title:"確定移除此筆資料?",onConfirm:C=>Fe(a.row.id),width:170,"hide-after":100,visible:H.value[a.row.id],"onUpdate:visible":C=>H.value[a.row.id]=C,placement:"left-end"},{reference:r(()=>[l(t,{size:"small",type:"danger"},{default:r(()=>e[24]||(e[24]=[v("移除")])),_:1})]),actions:r(({confirm:C,cancel:O})=>[l(t,{size:"small",onClick:O},{default:r(()=>e[25]||(e[25]=[v("沒有")])),_:2},1032,["onClick"]),l(t,{type:"danger",size:"small",onClick:C},{default:r(()=>e[26]||(e[26]=[v(" 是 ")])),_:2},1032,["onClick"])]),_:2},1032,["onConfirm","visible","onUpdate:visible"])]),_:1},8,["fixed"])]),_:1},8,["data"]),f("div",go,[e[27]||(e[27]=f("div",{class:"example-demonstration"},null,-1)),l(Pe,{layout:"prev, pager, next",total:D.total,"page-size":D.per_page,"current-page":D.current_page,"onUpdate:currentPage":e[6]||(e[6]=a=>D.current_page=a),onCurrentChange:Ae,background:""},null,8,["total","page-size","current-page"])])]),l(te,{modelValue:S.value,"onUpdate:modelValue":e[10]||(e[10]=a=>S.value=a),title:"新增",class:"productForm-dialog","align-center":""},{footer:r(()=>[l(t,{type:"primary",onClick:Ce},{default:r(()=>e[28]||(e[28]=[v("提交")])),_:1}),l(t,{onClick:Y},{default:r(()=>e[29]||(e[29]=[v("取消")])),_:1})]),default:r(()=>[l(eo,{"form-data":i,"onUpdate:formData":e[7]||(e[7]=a=>i=a),"file-list":q.value,"onUpdate:fileList":e[8]||(e[8]=a=>q.value=a),"upload-list":V(w),"onUpdate:uploadList":e[9]||(e[9]=a=>Ge(w)?w.value=a:w=a),onUploadList:ge,ref_key:"formRef",ref:B,mode:"add"},null,8,["form-data","file-list","upload-list"])]),_:1},8,["modelValue"]),l(te,{modelValue:K.value,"onUpdate:modelValue":e[17]||(e[17]=a=>K.value=a),title:X.value,width:"1000","align-center":""},{default:r(()=>[l(oo,{color_options_data:_.value,"onUpdate:color_options_data":e[11]||(e[11]=a=>_.value=a),fileList_co:L.value,"onUpdate:fileList_co":e[12]||(e[12]=a=>L.value=a),tempRow:u.value,"onUpdate:tempRow":e[13]||(e[13]=a=>u.value=a),editingRow:F.value,onToggleEdit:xe,onCancelEdit:Ve,onDelCo:Te,ref_key:"colorFormRef",ref:J},null,8,["color_options_data","fileList_co","tempRow","editingRow"]),l(to,{ref_key:"newCoFormRef",ref:$,newCoRowData:b.value,"onUpdate:newCoRowData":e[14]||(e[14]=a=>b.value=a),newCoRowVisible:U.value,"onUpdate:newCoRowVisible":e[15]||(e[15]=a=>U.value=a),fileListAdd_co:h.value,"onUpdate:fileListAdd_co":e[16]||(e[16]=a=>h.value=a),color_options_data:_.value,onToggleAdd:Le,onToggleAddBtn:Se,onRemoveVerify:De},null,8,["newCoRowData","newCoRowVisible","fileListAdd_co","color_options_data"])]),_:1},8,["modelValue","title"])]),_:1})}}},Ft=ao(fo,[["__scopeId","data-v-9183fb45"]]);export{Ft as default};
