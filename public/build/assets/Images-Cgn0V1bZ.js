import{E as Y}from"./base-Brf_yBAJ.js";import{E as Z}from"./el-scrollbar-CorRZexq.js";import"./el-tooltip-l0sNRNKZ.js";import{E as tt}from"./el-popper-BSwFi-Wn.js";/* empty css                 *//* empty css                        */import{E as et}from"./el-button-DwHekHmB.js";import{r as L,f as ot,p as I,y as st,g as nt,h as v,i as _,a as d,b as l,w as p,N as V,O as B,c as h,k as b,o as u,d as E,t as rt,u as it,n as at,X as lt}from"./app-lsMHx7PK.js";import{H as ct}from"./Header-CGSCE_LC.js";import{l as dt}from"./vue-draggable-plus-CyhlxW19.js";/* empty css                        */import{_ as pt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{E as ut}from"./index-B2x236EI.js";import{E as mt}from"./index-CgB4YGQ3.js";import{E as _t}from"./index-CiH_2dzV.js";import"./use-form-common-props-D5ONMDRx.js";import"./get-D4Sx4Yju.js";import"./isArray-Dxzbedgu.js";import"./index-6SUpneNt.js";import"./index-W2FmbPXI.js";import"./aria-n-U01RP3.js";import"./index-VxK2knAE.js";import"./icon-Domd4CnA.js";import"./el-col-B9g1VTzX.js";import"./typescript-Bp3YSIOJ.js";import"./el-avatar-CpBDBI5y.js";import"./castArray-Ce6QuK0j.js";import"./refs-DiFgKJQR.js";import"./index-BjFHEJIc.js";import"./event-BB_Ol6Sd.js";import"./index-DP1aPUMi.js";const ft={class:"max-w-[1440px] mx-auto px-4"},gt={class:"my-8"},ht={class:"scroll-wrapper",style:{position:"relative"}},kt={class:"scrollbar-flex-content images"},xt={class:"demo-image__preview"},wt={key:0,class:"watermark"},yt={class:"toggle_btn"},bt=["onChange"],Et=["onClick"],Ct={key:1},$t={__name:"Images",props:{productImages:Array,productId:String},setup(M){const C=M,f=L(C.productImages);let S=JSON.parse(JSON.stringify(C.productImages));const w=ot(()=>[...f.value].sort((e,t)=>e.color_code==="combo"?1:t.color_code==="combo"?-1:0)),N=L([]),P=e=>{N.value[e].click()},W=e=>e.map(t=>t.image),O=(e,t,o=null)=>{const n=w.value.find(s=>s.id===e);if(n)if(t===null&&o){const s=n.product_images.findIndex(i=>i.id===null&&i.uid===o);s!==-1&&n.product_images.splice(s,1)}else n.product_images.forEach(s=>{s.id===t&&(s._delete=!0)})},F=(e,t)=>{const o=w.value.find(n=>n.id===e);o&&o.product_images.forEach(n=>{n.id===t&&(n._delete=!1)})},J=(e,t)=>{const o=e.target.files;if(!o.length)return;const n=w.value.find(s=>s.id===t);n&&(Array.from(o).forEach(s=>{const i={id:null,uid:Date.now()+Math.random(),product_id:n.product_id,image:URL.createObjectURL(s),alt_text:"",is_combination:n.color_name==="組合色"?1:0,file:s};n.product_images.push(i)}),e.target.value="")},j=()=>f.value.map(e=>{const t=S.find(o=>o.id===e.id);return{po_id:e.id,product_images:e.product_images.filter(o=>{var m,g,y;const n=(m=t==null?void 0:t.product_images)==null?void 0:m.find($=>$.id===o.id),s=n&&((g=n.alt_text)==null?void 0:g.trim())!==((y=o.alt_text)==null?void 0:y.trim()),i=o._delete,c=o.id===null;return s||i||c}).map(o=>({id:o.id??null,alt_text:o.alt_text,is_combination:o.is_combination,_delete:o._delete??!1,image:o.id?o.image:o.file}))}}).filter(e=>e.product_images.length>0),z=async()=>{var n;const e=new FormData,t=j();let o=C.productId;t.forEach((s,i)=>{e.append(`product_options[${i}][po_id]`,s.po_id),s.product_images.forEach((c,m)=>{e.append(`product_options[${i}][product_images][${m}][id]`,c.id??""),e.append(`product_options[${i}][product_images][${m}][alt_text]`,c.alt_text),e.append(`product_options[${i}][product_images][${m}][is_combination]`,c.is_combination),e.append(`product_options[${i}][product_images][${m}][_delete]`,c._delete?1:0),c.id===null&&c.image instanceof File&&e.append(`product_options[${i}][product_images][${m}][image]`,c.image)})});for(const[s,i]of e.entries());if(!e.entries().next().done){e.append("product_id",o);try{const s=await axios.post("/back/products/updateProductImages",e,{headers:{"Content-Type":"multipart/form-data"},validateStatus:i=>i<400});f.value=s.data.updated_product_options||[],S=JSON.parse(JSON.stringify(s.data.updated_product_options)||[]),s.data&&D("success","更新成功")}catch(s){if(s.response&&s.response.status===403){const i=((n=s.response.data)==null?void 0:n.message)||"操作失敗";D("warning",i);return}}}},H=(e,t)=>{const o=e.oldIndex,n=e.newIndex,s=Math.min(o,n),i=Math.max(o,n),c=t.slice(s,i+1);c.forEach((m,g)=>{m.order=s+g+1}),X(c)},X=async e=>{try{const t=await axios.post("/back/products/reorderProductImgs",e,{})}catch{}},k=I({}),R=I({}),T=I({}),q=e=>{var o;const t=(o=k[e])==null?void 0:o.wrapRef;t&&(t.scrollTo({left:t.scrollWidth,behavior:"smooth"}),setTimeout(()=>A(e),500))};st(()=>{U()});function U(){Object.keys(k).forEach(e=>{var o;const t=(o=k[e])==null?void 0:o.wrapRef;t&&(R[e]=t.scrollWidth>t.clientWidth)})}nt(()=>f,()=>{lt(()=>U())},{deep:!0});function A(e){var n;const t=(n=k[e])==null?void 0:n.wrapRef;if(!t)return;const o=Math.abs(t.scrollLeft+t.clientWidth-t.scrollWidth)<1;T[e]=o}function G(e){const t=(e??"").trim();return t===""?null:t}const D=(e,t)=>{ut({type:e,title:t,position:"bottom-left"})};function K(){window.history.back()}return(e,t)=>{const o=v("ArrowLeft"),n=Y,s=et,i=mt,c=_t,m=v("Plus"),g=tt,y=v("ArrowRight"),$=Z;return u(),_(V,null,[d(ct),l("main",null,[l("div",ft,[l("p",gt,[d(s,{link:"",onClick:K,class:"hover:underline px-2 py-1"},{default:p(()=>[d(n,null,{default:p(()=>[d(o)]),_:1}),t[0]||(t[0]=E(" 回上一頁 "))]),_:1})]),f.value.length?(u(!0),_(V,{key:0},B(w.value,(a,It)=>(u(),_("div",{key:a.id,class:"images-outside"},[l("h1",null,rt(a.color_name),1),l("div",ht,[d($,{class:"scroll-container",ref_for:!0,ref:r=>k[a.id]=r,onScroll:r=>A(a.id)},{default:p(()=>[l("div",kt,[d(it(dt),{modelValue:a.product_images,"onUpdate:modelValue":r=>a.product_images=r,animation:150,ghostClass:"ghost",class:"flex",onEnd:r=>H(r,a.product_images)},{default:p(()=>[(u(!0),_(V,null,B(a.product_images,(r,Q)=>(u(),_("div",{key:r.uid||r.id,class:"image-wrapper"},[l("div",{class:at(["image-container",{"image-deleted":r._delete}])},[l("div",xt,[a.product_images.length?(u(),h(i,{key:0,style:{width:"100px",height:"100px"},src:r.image,"preview-src-list":W(a.product_images),"show-progress":"",fit:"cover","initial-index":Q},null,8,["src","preview-src-list","initial-index"])):b("",!0)]),r._delete?(u(),_("div",wt,t[1]||(t[1]=[l("span",null,"刪除",-1)]))):b("",!0)],2),d(c,{modelValue:r.alt_text,"onUpdate:modelValue":x=>r.alt_text=x,onChange:x=>r.alt_text=G(r.alt_text),style:{width:"200px"},placeholder:"Alt Text"},null,8,["modelValue","onUpdate:modelValue","onChange"]),l("div",yt,[r.id===null?(u(),h(s,{key:0,class:"upload-delete-btn",onClick:x=>O(a.id,null,r.uid)},{default:p(()=>t[2]||(t[2]=[l("span",{class:"default-text"},"待上傳",-1),l("span",{class:"hover-text"},"刪除",-1)])),_:2},1032,["onClick"])):r._delete?(u(),h(s,{key:2,onClick:x=>F(a.id,r.id),type:"danger",plain:"",class:"del_btn"},{default:p(()=>t[4]||(t[4]=[E("還原")])),_:2},1032,["onClick"])):(u(),h(s,{key:1,onClick:x=>O(a.id,r.id)},{default:p(()=>t[3]||(t[3]=[E("標記刪除")])),_:2},1032,["onClick"]))])]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onEnd"]),l("input",{type:"file",multiple:"",class:"hidden-input",ref_for:!0,ref:r=>N.value[a.id]=r,onChange:r=>J(r,a.id)},null,40,bt),l("div",{class:"upload-placeholder",onClick:r=>P(a.id)},[d(g,{class:"box-item",effect:"dark",content:"新增檔案",placement:"top"},{default:p(()=>[d(s,null,{default:p(()=>[d(n,null,{default:p(()=>[d(m)]),_:1})]),_:1})]),_:1})],8,Et)]),R[a.id]&&!T[a.id]?(u(),h(s,{key:0,class:"scroll-to-end-btn",onClick:r=>q(a.id)},{default:p(()=>[d(n,null,{default:p(()=>[d(y)]),_:1})]),_:2},1032,["onClick"])):b("",!0)]),_:2},1032,["onScroll"])])]))),128)):(u(),_("div",Ct," 尚無附圖資料 ")),l("div",null,[f.value.length?(u(),h(s,{key:0,type:"danger",onClick:z,class:"submit-button"},{default:p(()=>t[5]||(t[5]=[E("更新")])),_:1})):b("",!0)])])])],64)}}},ne=pt($t,[["__scopeId","data-v-c04120c7"]]);export{ne as default};
