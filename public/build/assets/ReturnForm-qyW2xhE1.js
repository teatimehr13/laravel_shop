import{b as Y,u as Z,_ as ee,w as te,E as oe}from"./base-DdF9LHzb.js";import{E as re}from"./el-button-DNj5ad6N.js";/* empty css                 *//* empty css                     */import"./el-tag-Ch_t78t2.js";import{E as se,a as ne}from"./el-select-vY8immTa.js";import"./el-scrollbar-D-M4snyz.js";import"./el-popper-B0TJAX3S.js";import{E as ae}from"./el-input-number-cnsnrEzR.js";import{E as le}from"./el-checkbox-XIduAFHh.js";import{C as R,f as E,aq as ie,o as d,c as U,w as u,A as de,n as z,u as ue,I as me,q as ce,r as C,p as S,g as pe,h as _e,i as _,b as o,a as i,N as w,O as k,k as fe,t as b,d as F,j as I,L as N}from"./app-rUP0WFHc.js";/* empty css                        */import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{E as ve}from"./index-BMrvmh7r.js";import{e as ge,a as be}from"./use-form-common-props-BeLgxl5I.js";import{a as xe,E as he}from"./index-CrKXfINh.js";import{E as qe}from"./index-C2tRIJKK.js";import"./aria-CAJK2HN2.js";import"./index-CTujAvOj.js";import"./get-Bq4Kqk5y.js";import"./isArray-Dxzbedgu.js";import"./icon-HjsV8w-5.js";import"./_Uint8Array-CHYqkzCa.js";import"./index-C9IVSUvu.js";import"./isEqual-nt7ctgGs.js";import"./castArray-Ce6QuK0j.js";import"./index-CR5GapiV.js";import"./index-B2iIRy8e.js";import"./event-BB_Ol6Sd.js";import"./index-CzXl0CR-.js";import"./index-C0yLCE33.js";import"./_baseClone-DZbmGIMq.js";import"./_initCloneObject-DgXXankK.js";import"./typescript-Bp3YSIOJ.js";import"./index-Dw169JbW.js";const we=Y({type:{type:String,values:["primary","success","info","warning","danger",""],default:""},size:{type:String,values:ge,default:""},truncated:Boolean,lineClamp:{type:[String,Number]},tag:{type:String,default:"span"}}),Ee=R({name:"ElText"}),Ve=R({...Ee,props:we,setup(m){const c=m,x=be(),a=Z("text"),f=E(()=>[a.b(),a.m(c.type),a.m(x.value),a.is("truncated",c.truncated),a.is("line-clamp",!ie(c.lineClamp))]);return(p,r)=>(d(),U(ce(p.tag),{class:z(ue(f)),style:me({"-webkit-line-clamp":p.lineClamp})},{default:u(()=>[de(p.$slots,"default")]),_:3},8,["class","style"]))}});var Ce=ee(Ve,[["__file","text.vue"]]);const Se=te(Ce),ke={key:0,class:"checkmark"},Fe={class:"item-imgs"},Ie=["src"],Ne={class:"item-details"},Re={class:"item-name flex"},Ue={class:"item-qty flex"},ze={class:"flex"},Be={class:"flex"},Ae={class:"flex"},Oe={class:"flex"},Te={__name:"ReturnForm",props:{order:Object,toCurrency:Function,return_reasons:Array},emits:["get-order-num","change-step"],setup(m,{expose:c,emit:x}){const a=m,f=x,p=C(""),r=S({});a.order.order_items.forEach(t=>{r[t.id]={quantity:0,reason:null,description:""}});const B=E(()=>Object.values(r).some(t=>t.quantity>0&&t.reason)),y=C(!1),A=E(()=>a.order.order_items.every(t=>{var e;return((e=r[t.id])==null?void 0:e.quantity)===t.available_qty}));pe(A,t=>{y.value=t});function O(t){a.order.order_items.forEach(e=>{r[e.id].quantity=t?e.available_qty:0})}const T={reason:[{required:!0,message:"請選擇退貨原因",trigger:"change"}]},j=async()=>{var t;for(const e of a.order.order_items){const n=e.id,q=((t=r[n])==null?void 0:t.quantity)??0,g=v[n];if(q===0&&(r[n].description="",g.resetFields("reason")),!await g.validate())throw new Error(`商品 ${n} 驗證失敗`)}},$=()=>{for(const t of a.order.order_items){const e=t.id,n=v[e];r[e].description="",r[e].quantity=0,n.resetFields("reason")}y.value=!1},D=async()=>{const t={order_id:a.order.id,items:Object.entries(r).filter(([e,n])=>n.quantity>0&&n.reason!=null).map(([e,n])=>({order_item_id:parseInt(e),quantity:n.quantity,reason:n.reason,description:n.description||""}))};try{const e=await axios.post("/return/returnRequest",t);h("success",e.data.msg)}catch(e){if(e.response&&e.response.data){const n=e.response.data;h("error",n.error||"發生未知錯誤")}else h("error","無法連接伺服器，請稍後再試")}},v=S({});function L(t,e){e===0&&v[t].resetFields("reason")}const P=async()=>{try{await j(),await D(),await f("get-order-num",a.order.order_number),await f("change-step",-2,"0%")}catch{}};c({returnRef:p,resetForm:$});const h=(t,e)=>{ve({type:t,title:e,position:"bottom-left"})};return(t,e)=>{const n=le,q=_e("Select"),g=oe,V=ae,K=Se,M=se,Q=ne,G=xe,H=he,J=qe,W=re;return d(),_(w,null,[o("div",null,[i(n,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=s=>y.value=s),label:"全選",onChange:O,border:""},null,8,["modelValue"])]),(d(!0),_(w,null,k(m.order.order_items,(s,je)=>(d(),_("div",{class:z(["return-con-layout",{"return-con-border":r[s.id].quantity>0}])},[r[s.id].quantity>0?(d(),_("i",ke,[i(g,null,{default:u(()=>[i(q)]),_:1})])):fe("",!0),o("div",Fe,[o("img",{src:s.image,style:{"max-width":"80px"}},null,8,Ie)]),o("div",Ne,[o("div",Re,[e[1]||(e[1]=o("div",null,"商品名稱",-1)),o("div",null,b(s.name),1)]),o("div",Ue,[e[2]||(e[2]=o("div",null,"訂單數量",-1)),o("div",null,b(s.quantity),1)]),o("div",ze,[e[3]||(e[3]=o("div",null,"單價",-1)),o("div",null,b(m.toCurrency(s.price)),1)]),o("div",Be,[e[4]||(e[4]=o("div",null,"退貨數量",-1)),o("div",null,[i(V,{modelValue:r[s.id].quantity,"onUpdate:modelValue":l=>r[s.id].quantity=l,min:0,max:s.available_qty,size:"small",style:{width:"100px"},onChange:l=>L(s.id,l)},null,8,["modelValue","onUpdate:modelValue","max","onChange"]),i(K,{style:{margin:"0 10px"},type:"danger"},{default:u(()=>[F("(可退數量："+b(s.available_qty)+")",1)]),_:2},1024)])]),I(o("div",Ae,[e[5]||(e[5]=o("div",null,"退貨原因",-1)),o("div",null,[i(H,{model:r[s.id],rules:T,ref_for:!0,ref:l=>v[s.id]=l},{default:u(()=>[i(G,{prop:"reason"},{default:u(()=>[i(Q,{modelValue:r[s.id].reason,"onUpdate:modelValue":l=>r[s.id].reason=l,placeholder:"選擇退貨原因",style:{width:"300px",display:"block"}},{default:u(()=>[(d(!0),_(w,null,k(m.return_reasons,(l,X)=>(d(),U(M,{key:X,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1032,["model"])])],512),[[N,r[s.id].quantity>0]]),I(o("div",Oe,[e[6]||(e[6]=o("div",null," 描述 ",-1)),o("div",null,[i(J,{maxlength:"30",style:{width:"300px"},"show-word-limit":"",type:"textarea",placeholder:"選填",modelValue:r[s.id].description,"onUpdate:modelValue":l=>r[s.id].description=l},null,8,["modelValue","onUpdate:modelValue"])])],512),[[N,r[s.id].quantity>0]])])],2))),256)),i(W,{type:"danger",onClick:P,disabled:!B.value,style:{margin:"10px",float:"right"}},{default:u(()=>e[7]||(e[7]=[F("提交")])),_:1},8,["disabled"])],64)}}},ht=ye(Te,[["__scopeId","data-v-43062ea5"]]);export{ht as default};
