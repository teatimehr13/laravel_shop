import{E as Y}from"./base-DdF9LHzb.js";import{E as Z}from"./el-scrollbar-D-M4snyz.js";import"./el-tooltip-l0sNRNKZ.js";import{E as tt}from"./el-popper-B0TJAX3S.js";/* empty css                 *//* empty css                        */import{E as et}from"./el-button-DNj5ad6N.js";import{r as D,f as ot,p as I,y as nt,g as st,h as v,i as m,a as d,b as a,w as c,N as V,O as L,c as h,k as b,o as p,d as E,t as rt,u as it,n as lt,X as at}from"./app-rUP0WFHc.js";import{H as dt}from"./Header-BmWDgAAb.js";import{l as ct}from"./vue-draggable-plus-DD6EI5HZ.js";/* empty css                        */import{_ as pt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{E as ut}from"./index-BMrvmh7r.js";import{E as mt}from"./index-B8VzbdOh.js";import{E as _t}from"./index-C2tRIJKK.js";import"./use-form-common-props-BeLgxl5I.js";import"./get-Bq4Kqk5y.js";import"./isArray-Dxzbedgu.js";import"./index-CR5GapiV.js";import"./index-C9IVSUvu.js";import"./aria-CAJK2HN2.js";import"./index-CTujAvOj.js";import"./icon-HjsV8w-5.js";import"./el-col-CWY6KSpn.js";import"./typescript-Bp3YSIOJ.js";import"./el-avatar-D50oI0pS.js";import"./castArray-Ce6QuK0j.js";import"./refs-C5awHzNN.js";import"./index-Dw169JbW.js";import"./event-BB_Ol6Sd.js";import"./index-B2iIRy8e.js";const ft={class:"max-w-[1440px] mx-auto px-4"},gt={class:"my-8"},ht={class:"scroll-wrapper",style:{position:"relative"}},kt={class:"scrollbar-flex-content images"},xt={class:"demo-image__preview"},wt={key:0,class:"watermark"},yt={class:"toggle_btn"},bt=["onChange"],Et=["onClick"],Ct={key:1},$t={__name:"Images",props:{productImages:Array,productId:String},setup(B){const C=B,_=D(C.productImages);let N=JSON.parse(JSON.stringify(C.productImages));const w=ot(()=>[..._.value].sort((e,t)=>e.color_code==="combo"?1:t.color_code==="combo"?-1:0)),O=D([]),M=e=>{O.value[e].click()},P=e=>e.map(t=>t.image),R=(e,t,o=null)=>{const n=w.value.find(s=>s.id===e);if(n)if(t===null&&o){const s=n.product_images.findIndex(l=>l.id===null&&l.uid===o);s!==-1&&n.product_images.splice(s,1)}else n.product_images.forEach(s=>{s.id===t&&(s._delete=!0)})},W=(e,t)=>{const o=w.value.find(n=>n.id===e);o&&o.product_images.forEach(n=>{n.id===t&&(n._delete=!1)})},F=(e,t)=>{const o=e.target.files;if(!o.length)return;const n=w.value.find(s=>s.id===t);n&&(Array.from(o).forEach(s=>{const l={id:null,uid:Date.now()+Math.random(),product_id:n.product_id,image:URL.createObjectURL(s),alt_text:"",is_combination:n.color_name==="組合色"?1:0,file:s};n.product_images.push(l)}),e.target.value="")},J=()=>_.value.map(e=>{const t=N.find(o=>o.id===e.id);return{po_id:e.id,product_images:e.product_images.filter(o=>{var f,g,y;const n=(f=t==null?void 0:t.product_images)==null?void 0:f.find($=>$.id===o.id),s=n&&((g=n.alt_text)==null?void 0:g.trim())!==((y=o.alt_text)==null?void 0:y.trim()),l=o._delete,u=o.id===null;return s||l||u}).map(o=>({id:o.id??null,alt_text:o.alt_text,is_combination:o.is_combination,_delete:o._delete??!1,image:o.id?o.image:o.file}))}}).filter(e=>e.product_images.length>0),j=()=>{const e=new FormData,t=J();let o=C.productId;t.forEach((n,s)=>{e.append(`product_options[${s}][po_id]`,n.po_id),n.product_images.forEach((l,u)=>{e.append(`product_options[${s}][product_images][${u}][id]`,l.id??""),e.append(`product_options[${s}][product_images][${u}][alt_text]`,l.alt_text),e.append(`product_options[${s}][product_images][${u}][is_combination]`,l.is_combination),e.append(`product_options[${s}][product_images][${u}][_delete]`,l._delete?1:0),l.id===null&&l.image instanceof File&&e.append(`product_options[${s}][product_images][${u}][image]`,l.image)})});for(const[n,s]of e.entries());e.entries().next().done||(e.append("product_id",o),axios.post("/back/products/updateProductImages",e,{headers:{"Content-Type":"multipart/form-data"}}).then(n=>{_.value=n.data.updated_product_options||[],N=JSON.parse(JSON.stringify(n.data.updated_product_options)||[]),n.data&&G("success","更新成功")}))},z=(e,t)=>{const o=e.oldIndex,n=e.newIndex,s=Math.min(o,n),l=Math.max(o,n),u=t.slice(s,l+1);u.forEach((f,g)=>{f.order=s+g+1}),H(u)},H=async e=>{try{const t=await axios.post("/back/products/reorderProductImgs",e,{})}catch{}},k=I({}),S=I({}),T=I({}),X=e=>{var o;const t=(o=k[e])==null?void 0:o.wrapRef;t&&(t.scrollTo({left:t.scrollWidth,behavior:"smooth"}),setTimeout(()=>A(e),500))};nt(()=>{U()});function U(){Object.keys(k).forEach(e=>{var o;const t=(o=k[e])==null?void 0:o.wrapRef;t&&(S[e]=t.scrollWidth>t.clientWidth)})}st(()=>_,()=>{at(()=>U())},{deep:!0});function A(e){var n;const t=(n=k[e])==null?void 0:n.wrapRef;if(!t)return;const o=Math.abs(t.scrollLeft+t.clientWidth-t.scrollWidth)<1;T[e]=o}function q(e){const t=(e??"").trim();return t===""?null:t}const G=(e,t)=>{ut({type:e,title:t,position:"bottom-left"})};function K(){window.history.back()}return(e,t)=>{const o=v("ArrowLeft"),n=Y,s=et,l=mt,u=_t,f=v("Plus"),g=tt,y=v("ArrowRight"),$=Z;return p(),m(V,null,[d(dt),a("main",null,[a("div",ft,[a("p",gt,[d(s,{link:"",onClick:K,class:"hover:underline px-2 py-1"},{default:c(()=>[d(n,null,{default:c(()=>[d(o)]),_:1}),t[0]||(t[0]=E(" 回上一頁 "))]),_:1})]),_.value.length?(p(!0),m(V,{key:0},L(w.value,(i,It)=>(p(),m("div",{key:i.id,class:"images-outside"},[a("h1",null,rt(i.color_name),1),a("div",ht,[d($,{class:"scroll-container",ref_for:!0,ref:r=>k[i.id]=r,onScroll:r=>A(i.id)},{default:c(()=>[a("div",kt,[d(it(ct),{modelValue:i.product_images,"onUpdate:modelValue":r=>i.product_images=r,animation:150,ghostClass:"ghost",class:"flex",onEnd:r=>z(r,i.product_images)},{default:c(()=>[(p(!0),m(V,null,L(i.product_images,(r,Q)=>(p(),m("div",{key:r.uid||r.id,class:"image-wrapper"},[a("div",{class:lt(["image-container",{"image-deleted":r._delete}])},[a("div",xt,[i.product_images.length?(p(),h(l,{key:0,style:{width:"100px",height:"100px"},src:r.image,"preview-src-list":P(i.product_images),"show-progress":"",fit:"cover","initial-index":Q},null,8,["src","preview-src-list","initial-index"])):b("",!0)]),r._delete?(p(),m("div",wt,t[1]||(t[1]=[a("span",null,"刪除",-1)]))):b("",!0)],2),d(u,{modelValue:r.alt_text,"onUpdate:modelValue":x=>r.alt_text=x,onChange:x=>r.alt_text=q(r.alt_text),style:{width:"200px"},placeholder:"Alt Text"},null,8,["modelValue","onUpdate:modelValue","onChange"]),a("div",yt,[r.id===null?(p(),h(s,{key:0,class:"upload-delete-btn",onClick:x=>R(i.id,null,r.uid)},{default:c(()=>t[2]||(t[2]=[a("span",{class:"default-text"},"待上傳",-1),a("span",{class:"hover-text"},"刪除",-1)])),_:2},1032,["onClick"])):r._delete?(p(),h(s,{key:2,onClick:x=>W(i.id,r.id),type:"danger",plain:"",class:"del_btn"},{default:c(()=>t[4]||(t[4]=[E("還原")])),_:2},1032,["onClick"])):(p(),h(s,{key:1,onClick:x=>R(i.id,r.id)},{default:c(()=>t[3]||(t[3]=[E("標記刪除")])),_:2},1032,["onClick"]))])]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onEnd"]),a("input",{type:"file",multiple:"",class:"hidden-input",ref_for:!0,ref:r=>O.value[i.id]=r,onChange:r=>F(r,i.id)},null,40,bt),a("div",{class:"upload-placeholder",onClick:r=>M(i.id)},[d(g,{class:"box-item",effect:"dark",content:"新增檔案",placement:"top"},{default:c(()=>[d(s,null,{default:c(()=>[d(n,null,{default:c(()=>[d(f)]),_:1})]),_:1})]),_:1})],8,Et)]),S[i.id]&&!T[i.id]?(p(),h(s,{key:0,class:"scroll-to-end-btn",onClick:r=>X(i.id)},{default:c(()=>[d(n,null,{default:c(()=>[d(y)]),_:1})]),_:2},1032,["onClick"])):b("",!0)]),_:2},1032,["onScroll"])])]))),128)):(p(),m("div",Ct," 尚無附圖資料 ")),a("div",null,[_.value.length?(p(),h(s,{key:0,type:"danger",onClick:j,class:"submit-button"},{default:c(()=>t[5]||(t[5]=[E("更新")])),_:1})):b("",!0)])])])],64)}}},se=pt($t,[["__scopeId","data-v-4e2058da"]]);export{se as default};
